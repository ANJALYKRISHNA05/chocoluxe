<%- include('../partials/admin/header') %>

<body>
  <div class="content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <%- include('../partials/admin/sidebar', { activePage: 'products' }) %>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Products</h1>
            <a href="/admin/products/add" class="btn btn-primary">Add Product</a>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th scope="col" style="padding: 12px;">Image</th>
                  <th scope="col" style="padding: 12px;">Name</th>
                  <th scope="col" style="padding: 12px;">Category</th>
                  <th scope="col" style="padding: 12px;">Variants</th>
                  <th scope="col" style="padding: 12px;">Status</th>
                  <th scope="col" style="padding: 12px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach((product) => { %>
                  <tr>
                    <td style="padding: 12px; vertical-align: middle;">
                      <% if (product.variants[0].productImage.length > 0) { %>
                        <img src="<%= product.variants[0].productImage[0] %>" alt="<%= product.productName %>" style="width: 60px; height: 60px; object-fit: cover; margin-right: 10px;">
                      <% } else { %>
                        No Image
                      <% } %>
                    </td>
                    <td style="padding: 12px; vertical-align: middle;"><%= product.productName %></td>
                    <td style="padding: 12px; vertical-align: middle;"><%= product.category && product.category.name ? product.category.name : 'No Category' %></td>
                    <td style="padding: 12px; vertical-align: middle;">
                      <% product.variants.forEach((variant, index) => { %>
                        <div>
                          Variant <%= index + 1 %>: <%= variant.flavor %>, <%= variant.sugarLevel %>, <%= variant.weight %>g, Stock: <%= variant.stock_quantity %>, Price: ₹<%= variant.salePrice.toFixed(2) %>
                        </div>
                      <% }) %>
                    </td>
                    <td style="padding: 12px; vertical-align: middle;"><%= product.isBlocked ? 'Blocked' : 'Active' %></td>
                    <td style="padding: 12px; vertical-align: middle;">
                      <a href="/admin/products/edit/<%= product._id %>" class="btn btn-sm btn-warning" style="margin-right: 5px;">Edit</a>
                      <button class="btn btn-sm <%= product.isBlocked ? 'btn-success' : 'btn-danger' %>" onclick="toggleStatus('<%= product._id %>', <%= product.isBlocked %>)">
                        <%= product.isBlocked ? 'Unblock' : 'Block' %>
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

        
          <% if (totalPages > 1) { %>
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                  <a class="page-link" href="/admin/products?page=<%= currentPage - 1 %>&limit=<%= limit %>" aria-label="Previous">
                    <span aria-hidden="true">«</span>
                  </a>
                </li>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="/admin/products?page=<%= i %>&limit=<%= limit %>"><%= i %></a>
                  </li>
                <% } %>
                
                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                  <a class="page-link" href="/admin/products?page=<%= currentPage + 1 %>&limit=<%= limit %>" aria-label="Next">
                    <span aria-hidden="true">»</span>
                  </a>
                </li>
              </ul>
            </nav>
          <% } %>
          
          <div class="text-center mt-3">
            <p>Showing <%= products.length %> of <%= totalProducts %> products</p>
          </div>

        </main>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
    
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('success') === 'true') {
        Swal.fire({
          title: 'Success!',
          text: 'Product added successfully.',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        }).then(() => {
          
          window.history.replaceState({}, document.title, window.location.pathname);
        });
      }
    });

    async function toggleStatus(productId, isBlocked) {
      const action = isBlocked ? 'unblock' : 'block';
      const result = await Swal.fire({
        title: `Are you sure you want to ${action} this product?`,
        text: "This action cannot be undone!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: `Yes, ${action} it!`
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/admin/products/toggle-status/${productId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await response.json();
          if (data.success) {
            Swal.fire({
              title: 'Success!',
              text: `Product has been ${action}ed windingsuccessfully.`,
              icon: 'success',
              timer: 2000,
              showConfirmButton: false
            }).then(() => location.reload());
          } else {
            Swal.fire({
              title: 'Error!',
              text: 'Error toggling product status.',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        } catch (error) {
          console.error('Error:', error);
          Swal.fire({
            title: 'Error!',
            text: 'Error toggling product status.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      }
    }
  </script>

  <%- include('../partials/admin/footer') %>
</body>
</html>