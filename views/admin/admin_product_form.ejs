<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --primary-color: #4a2c2a;
            --secondary-color: #d1a876;
            --text-color: #fff9e6;
            --accent-color: #c99b6b;
            --bg-color: #f8f9fa;
        }
        
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: var(--text-color);
            border-bottom: 2px solid var(--secondary-color);
            padding: 15px 20px;
        }
        
        .btn-chocolate {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            font-weight: 600;
        }
        
        .btn-chocolate:hover {
            background-color: var(--accent-color);
            color: var(--primary-color);
        }
        
        .variant-card {
            border: 1px solid #e9e2d5;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            position: relative;
        }
        
        .remove-variant {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #dc3545;
            font-size: 1.2rem;
        }
        
        .preview-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .preview-image {
            width: 100px;
            height: 100px;
            border-radius: 4px;
            border: 2px solid #e9e2d5;
            position: relative;
            overflow: hidden;
        }
        
        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 3px;
            right: 3px;
            background-color: rgba(220, 53, 69, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .crop-image {
            position: absolute;
            top: 3px;
            left: 3px;
            background-color: rgba(0, 123, 255, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .required-field::after {
            content: '*';
            color: #dc3545;
            margin-left: 4px;
        }
        
        .cropper-container {
            max-height: 400px;
            width: 100%;
        }
        
        #cropperModal .modal-dialog {
            max-width: 800px;
        }
    </style>
</head>
<body>
    <%- include('../partials/admin/header') %>
    <%- include('../partials/admin/sidebar', { activePage: 'products' }) %>
    
    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h2 class="mb-3"><%= isEdit ? 'Edit' : 'Add' %> Product</h2>
                </div>
                <div class="col-md-6 text-end">
                    <a href="/admin/products" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Products
                    </a>
                </div>
            </div>
            
            <% if (error) { %>
                <div class="alert alert-danger" role="alert">
                    <%= error %>
                </div>
            <% } %>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><%= isEdit ? 'Edit' : 'Add' %> Product Details</h5>
                </div>
                <div class="card-body">
                    <form id="productForm" action="/admin/products/<%= isEdit ? 'edit/' + product._id : 'add' %>" method="POST" enctype="multipart/form-data">
                        <!-- Basic Info Section -->
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3">
                                <h5>Basic Information</h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="productName" class="form-label required-field">Product Name</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="productName" 
                                    name="productName" 
                                    value="<%= product ? product.productName : '' %>" 
                                    required
                                >
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="category" class="form-label required-field">Category</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">Select Category</option>
                                    <% categories.forEach(category => { %>
                                        <option 
                                            value="<%= category._id %>" 
                                            <%= product && product.category && product.category._id.toString() === category._id.toString() ? 'selected' : '' %>
                                        >
                                            <%= category.name %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label for="description" class="form-label required-field">Description</label>
                                <textarea 
                                    class="form-control" 
                                    id="description" 
                                    name="description" 
                                    rows="5" 
                                    required
                                ><%= product ? product.description : '' %></textarea>
                            </div>
                        </div>
                        
                        <!-- Product Images Section -->
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3">
                                <h5>Product Images</h5>
                                <p class="text-muted">Upload at least 3 images of your product</p>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label for="productImages" class="form-label required-field">Images</label>
                                <input 
                                    type="file" 
                                    class="form-control" 
                                    id="productImages" 
                                    name="productImages" 
                                    accept="image/*" 
                                    multiple
                                    <%= isEdit ? '' : 'required' %>
                                >
                                <div class="form-text">Select multiple images at once (min 3 images)</div>
                            </div>
                            
                            <div class="col-md-12">
                                <div id="imagePreviewContainer" class="preview-images">
                                    <% if (product && product.variants && product.variants[0] && product.variants[0].productImage) { %>
                                        <% product.variants[0].productImage.forEach((img, imgIndex) => { %>
                                            <div class="preview-image">
                                                <img src="<%= img %>" alt="Product Image">
                                                <input type="hidden" name="existingImages" value="<%= img %>">
                                                <span class="remove-image" data-index="<%= imgIndex %>">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                <span class="crop-image" data-index="<%= imgIndex %>" data-src="<%= img %>">
                                                    <i class="fas fa-crop-alt"></i>
                                                </span>
                                            </div>
                                        <% }); %>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Variants Section -->
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3 d-flex justify-content-between align-items-center">
                                <h5>Product Variants</h5>
                                <button type="button" class="btn btn-chocolate" id="addVariantBtn">
                                    <i class="fas fa-plus-circle me-2"></i>Add Variant
                                </button>
                            </div>
                            
                            <div class="col-md-12">
                                <div id="variantsContainer">
                                    <% 
                                    if (product && product.variants && product.variants.length > 0) { 
                                        product.variants.forEach((variant, index) => { 
                                    %>
                                        <div class="variant-card" id="variant-<%= index %>">
                                            <span class="remove-variant" data-index="<%= index %>"><i class="fas fa-times"></i></span>
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Flavor</label>
                                                    <select class="form-select" name="flavors" required>
                                                        <option value="Almond" <%= variant.flavor === 'Almond' ? 'selected' : '' %>>Almond</option>
                                                        <option value="Caramel" <%= variant.flavor === 'Caramel' ? 'selected' : '' %>>Caramel</option>
                                                        <option value="Peanut" <%= variant.flavor === 'Peanut' ? 'selected' : '' %>>Peanut</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Sugar Level</label>
                                                    <select class="form-select" name="sugarLevels" required>
                                                        <option value="Low" <%= variant.sugarLevel === 'Low' ? 'selected' : '' %>>Low</option>
                                                        <option value="Medium" <%= variant.sugarLevel === 'Medium' ? 'selected' : '' %>>Medium</option>
                                                        <option value="Sugar-Free" <%= variant.sugarLevel === 'Sugar-Free' ? 'selected' : '' %>>Sugar-Free</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Weight (g)</label>
                                                    <select class="form-select" name="weights" required>
                                                        <option value="50" <%= variant.weight === 50 ? 'selected' : '' %>>50g</option>
                                                        <option value="100" <%= variant.weight === 100 ? 'selected' : '' %>>100g</option>
                                                        <option value="200" <%= variant.weight === 200 ? 'selected' : '' %>>200g</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Stock Quantity</label>
                                                    <input type="number" class="form-control" name="stockQuantities" value="<%= variant.stock_quantity %>" min="0" required>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Regular Price (₹)</label>
                                                    <input type="number" class="form-control" name="regularPrices" value="<%= variant.regularPrice %>" min="0" step="0.01" required>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Sale Price (₹)</label>
                                                    <input type="number" class="form-control" name="salePrices" value="<%= variant.salePrice %>" min="0" step="0.01" required>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); } else { %>
                                        <div class="variant-card" id="variant-0">
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Flavor</label>
                                                    <select class="form-select" name="flavors" required>
                                                        <option value="Almond">Almond</option>
                                                        <option value="Caramel">Caramel</option>
                                                        <option value="Peanut">Peanut</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Sugar Level</label>
                                                    <select class="form-select" name="sugarLevels" required>
                                                        <option value="Low">Low</option>
                                                        <option value="Medium">Medium</option>
                                                        <option value="Sugar-Free">Sugar-Free</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Weight (g)</label>
                                                    <select class="form-select" name="weights" required>
                                                        <option value="50">50g</option>
                                                        <option value="100">100g</option>
                                                        <option value="200">200g</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Stock Quantity</label>
                                                    <input type="number" class="form-control" name="stockQuantities" value="100" min="0" required>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Regular Price (₹)</label>
                                                    <input type="number" class="form-control" name="regularPrices" value="250" min="0" step="0.01" required>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label required-field">Sale Price (₹)</label>
                                                    <input type="number" class="form-control" name="salePrices" value="199" min="0" step="0.01" required>
                                                </div>
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='/admin/products'">Cancel</button>
                                <button type="submit" class="btn btn-chocolate">
                                    <i class="fas fa-save me-2"></i><%= isEdit ? 'Update' : 'Save' %> Product
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cropper Modal -->
    <div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="cropper-container">
                        <img id="imageToCrop" src="" alt="Image to crop">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-chocolate" id="cropImageBtn">Crop & Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <%- include('../partials/admin/footer') %>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('productImages');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
            const imageToCrop = document.getElementById('imageToCrop');
            const cropImageBtn = document.getElementById('cropImageBtn');
            let cropper = null;
            let currentPreviewDiv = null;
            let currentFileName = null;
            const croppedFiles = new Map();
            
            // Initialize Cropper.js
            function initCropper(imageSrc, callback) {
                imageToCrop.src = imageSrc;
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    ready: function() {
                        callback();
                    }
                });
            }
            
            // Handle image upload
            imageInput.addEventListener('change', function() {
                const files = this.files;
                
                if (files.length < 3 && document.querySelectorAll('.preview-image').length === 0) {
                    alert('Please select at least 3 images');
                    this.value = '';
                    return;
                }
                
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'preview-image';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <span class="remove-image" data-file="${file.name}">
                                <i class="fas fa-times"></i>
                            </span>
                            <span class="crop-image" data-file="${file.name}">
                                <i class="fas fa-crop-alt"></i>
                            </span>
                        `;
                        previewContainer.appendChild(previewDiv);
                        
                        // Add remove event
                        previewDiv.querySelector('.remove-image').addEventListener('click', function() {
                            previewDiv.remove();
                            croppedFiles.delete(file.name);
                        });
                        
                        // Add crop event
                        previewDiv.querySelector('.crop-image').addEventListener('click', function() {
                            currentPreviewDiv = previewDiv;
                            currentFileName = file.name;
                            initCropper(e.target.result, () => {
                                cropperModal.show();
                            });
                        });
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            // Handle existing images crop
            document.querySelectorAll('.crop-image').forEach(btn => {
                btn.addEventListener('click', function() {
                    const imgSrc = this.getAttribute('data-src');
                    currentPreviewDiv = this.closest('.preview-image');
                    currentFileName = `existing-${this.getAttribute('data-index')}`;
                    initCropper(imgSrc, () => {
                        cropperModal.show();
                    });
                });
            });
            
            // Handle crop and save
            cropImageBtn.addEventListener('click', function() {
                const canvas = cropper.getCroppedCanvas({
                    width: 800,
                    height: 800
                });
                
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    currentPreviewDiv.querySelector('img').src = url;
                    croppedFiles.set(currentFileName, blob);
                    
                    // Update form data
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.name = 'productImages';
                    input.hidden = true;
                    const file = new File([blob], currentFileName + '.png', { type: 'image/png' });
                    const container = new DataTransfer();
                    container.items.add(file);
                    input.files = container.files;
                    currentPreviewDiv.appendChild(input);
                    
                    // Remove existing image input if it exists
                    const existingInput = currentPreviewDiv.querySelector('input[name="existingImages"]');
                    if (existingInput) {
                        existingInput.remove();
                    }
                    
                    cropperModal.hide();
                }, 'image/png');
            });
            
            // Remove existing images
            document.querySelectorAll('.remove-image').forEach(btn => {
                btn.addEventListener('click', function() {
                    const imgContainer = this.closest('.preview-image');
                    imgContainer.remove();
                });
            });
            
            // Handle variants
            let variantCounter = document.querySelectorAll('.variant-card').length;
            
            document.getElementById('addVariantBtn').addEventListener('click', function() {
                const variantsContainer = document.getElementById('variantsContainer');
                const newIndex = variantCounter++;
                
                const variantCard = document.createElement('div');
                variantCard.className = 'variant-card';
                variantCard.id = `variant-${newIndex}`;
                
                variantCard.innerHTML = `
                    <span class="remove-variant" data-index="${newIndex}"><i class="fas fa-times"></i></span>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label required-field">Flavor</label>
                            <select class="form-select" name="flavors" required>
                                <option value="Almond">Almond</option>
                                <option value="Caramel">Caramel</option>
                                <option value="Peanut">Peanut</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required-field">Sugar Level</label>
                            <select class="form-select" name="sugarLevels" required>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="Sugar-Free">Sugar-Free</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required-field">Weight (g)</label>
                            <select class="form-select" name="weights" required>
                                <option value="50">50g</option>
                                <option value="100">100g</option>
                                <option value="200">200g</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required-field">Stock Quantity</label>
                            <input type="number" class="form-control" name="stockQuantities" value="100" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required-field">Regular Price (₹)</label>
                            <input type="number" class="form-control" name="regularPrices" value="250" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required-field">Sale Price (₹)</label>
                            <input type="number" class="form-control" name="salePrices" value="199" min="0" step="0.01" required>
                        </div>
                    </div>
                `;
                
                variantsContainer.appendChild(variantCard);
                
                variantCard.querySelector('.remove-variant').addEventListener('click', function() {
                    removeVariant(this);
                });
            });
            
            function removeVariant(element) {
                const variantContainer = element.closest('.variant-card');
                const variantsCount = document.querySelectorAll('.variant-card').length;
                
                if (variantsCount <= 1) {
                    alert('Product must have at least one variant');
                    return;
                }
                
                variantContainer.remove();
            }
            
            document.querySelectorAll('.remove-variant').forEach(btn => {
                btn.addEventListener('click', function() {
                    removeVariant(this);
                });
            });
            
            // Form validation
            document.getElementById('productForm').addEventListener('submit', function(e) {
                const imageCount = document.querySelectorAll('.preview-image').length;
                const variantCount = document.querySelectorAll('.variant-card').length;
                
                if (imageCount < 3) {
                    e.preventDefault();
                    alert('Please upload at least 3 images');
                    return false;
                }
                
                if (variantCount < 1) {
                    e.preventDefault();
                    alert('Product must have at least one variant');
                    return false;
                }
                
                return true;
            });
        });
    </script>
</body>
</html>